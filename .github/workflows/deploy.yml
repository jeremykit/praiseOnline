
name: Deploy Worker
permissions:
  contents: read

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 替换所有配置占位符
      - name: Replace placeholders in configuration
        run: |
          # 替换 wrangler.toml 中的配置
          sed -i "s|__BUCKET_NAME__|${{ secrets.BUCKET_NAME }}|g" worker/wrangler.toml
          sed -i "s|__API_DOMAIN__|${{ secrets.API_DOMAIN }}|g" worker/wrangler.toml
          sed -i "s|__ZONE_NAME__|${{ secrets.ZONE_NAME }}|g" worker/wrangler.toml
          
          # 替换 pages/index.html 中的 API_BASE
          sed -i "s|__API_BASE__|${{ secrets.API_DOMAIN }}|g" pages/index.html
      
      # 安装最新版本的 wrangler
      - name: Setup Node.js and Wrangler
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install -g wrangler@latest

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
          command: deploy --minify index.js

      # 部署 Pages
      - name: Deploy Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: pages
          command: pages deploy . --project-name=${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
